<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二次元动漫壁纸接口</title>
    <style>
        body { margin: 2rem; font-family: sans-serif; background: #f8f9fa; }
        h1 { color: #333; }
        .api-desc { margin: 1rem 0; padding: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .api-link { color: #0969da; text-decoration: none; font-weight: 500; }
        .api-link:hover { text-decoration: underline; }
        /* 新增：单张图预览样式 */
        .single-preview { margin-top: 2rem; text-align: center; }
        .single-preview img { max-width: 80%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .single-preview p { margin-top: 1rem; color: #666; font-size: 0.95rem; }
    </style>
</head>
<body>
    <h1>二次元动漫壁纸图床 & 接口</h1>
    <div class="api-desc">
        <p><strong>1. 随机获取一张动漫壁纸（直接返回图片）</strong><br>
        调用地址：<a href="?type=random" class="api-link">https://api.tengyuesj.cn?type=random</a></p>
        
        <p><strong>2. 随机壁纸接口（返回JSON数据）</strong><br>
        调用地址：<a href="?type=random&format=json" class="api-link">https://api.tengyuesj.cn?type=random&format=json</a></p>
        
        <p><strong>3. 获取所有动漫壁纸列表（JSON）</strong><br>
        调用地址：<a href="?type=list&format=json" class="api-link">https://api.tengyuesj.cn?type=list&format=json</a></p>
    </div>

    <!-- 新增：单张随机图预览容器（默认隐藏，有参数时显示） -->
    <div class="single-preview" id="singlePreview" style="display: none;"></div>

    <script>
        // 解析接口参数
        const urlParams = new URLSearchParams(window.location.search);
        const apiType = urlParams.get('type'); // random/list
        const returnFormat = urlParams.get('format'); // json/空

        // GitHub仓库图片文件夹地址（固定）
        const fetchUrl = 'https://api.github.com/repos/MANKALOHO/wallpaper-picbed/contents/2025';

        // 核心：获取图片列表并处理
        fetch(fetchUrl, {
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Accept': 'application/json'
            }
        })
        .then(res => {
            if (!res.ok) throw new Error(`GitHub接口请求失败，状态码：${res.status}`);
            return res.json();
        })
        .then(files => {
            // 筛选有效图片（png/jpg/jpeg/webp）
            const validImgs = files
                .filter(file => file.type === 'file' && /\.(png|jpg|jpeg|webp)$/i.test(file.name))
                .map(file => ({
                    name: file.name,
                    url: `https://cdn.jsdelivr.net/gh/MANKALOHO/wallpaper-picbed@main/${file.path}`,
                    size: (file.size / 1024).toFixed(2) + 'KB',
                    updateTime: new Date(file.last_modified).toLocaleDateString()
                }));

            if (validImgs.length === 0) throw new Error('未找到任何有效图片');

            // 1. 处理 ?type=random（核心：直接跳转/返回JSON/显示单张图）
            if (apiType === 'random') {
                const randomImg = validImgs[Math.floor(Math.random() * validImgs.length)];
                
                // 1.1 返回JSON（?type=random&format=json）
                if (returnFormat === 'json') {
                    document.body.innerHTML = ''; // 清空页面
                    document.body.style.whiteSpace = 'pre';
                    document.write(JSON.stringify({
                        code: 200,
                        message: '随机壁纸获取成功',
                        data: {
                            图片名称: randomImg.name,
                            图片直链: randomImg.url,
                            文件大小: randomImg.size,
                            最后更新: randomImg.updateTime
                        }
                    }, null, 2));
                } 
                // 1.2 直接跳转图片（?type=random，插件调用用这个）
                else {
                    window.location.href = randomImg.url; // 前端JS跳转，模拟PHP的302效果
                }
            }

            // 2. 处理 ?type=list&format=json（返回所有图片列表）
            else if (apiType === 'list' && returnFormat === 'json') {
                document.body.innerHTML = '';
                document.body.style.whiteSpace = 'pre';
                document.write(JSON.stringify({
                    code: 200,
                    message: '图片列表获取成功',
                    total: validImgs.length,
                    list: validImgs
                }, null, 2));
            }

            // 3. 无参数/其他参数：显示1张随机图（不显示全部）
            else {
                const randomImg = validImgs[Math.floor(Math.random() * validImgs.length)];
                const previewContainer = document.getElementById('singlePreview');
                previewContainer.style.display = 'block'; // 显示预览容器
                // 插入单张图和信息
                previewContainer.innerHTML = `
                    <img src="${randomImg.url}" alt="${randomImg.name}">
                    <p>图片名称：${randomImg.name} | 大小：${randomImg.size} | 最后更新：${randomImg.updateTime}</p>
                    <p><a href="?type=random" class="api-link">点击获取另一张随机图</a></p>
                `;
            }
        })
        .catch(err => {
            // 错误处理（显示友好提示）
            document.body.innerHTML = `
                <div style="color: #dc3545; margin-top: 2rem;">
                    <h3>❌ 接口出错：${err.message}</h3>
                    <p>建议10秒后重试，或检查GitHub仓库是否正常</p>
                </div>
            `;
            console.error('接口错误详情：', err);
        });
    </script>
</body>
</html>
