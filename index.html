<?php
// 新增：服务器端优先处理 ?type=random，直接返回HTTP跳转（核心修改）
if (isset($_GET['type']) && $_GET['type'] === 'random') {
    // 1. 从GitHub接口获取图片列表（和JS逻辑一致）
    $githubApi = 'https://api.github.com/repos/MANKALOHO/wallpaper-picbed/contents/2025';
    $options = [
        'http' => [
            'method' => 'GET',
            'header' => [
                'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Accept: application/json'
            ],
            'timeout' => 10
        ],
        'ssl' => [
            'verify_peer' => false, // 忽略SSL验证（避免服务器环境问题）
            'verify_peer_name' => false
        ]
    ];
    $context = stream_context_create($options);
    $githubResponse = file_get_contents($githubApi, false, $context);
    $files = json_decode($githubResponse, true);

    // 2. 筛选有效图片并随机选一张（和JS逻辑一致）
    $validImgs = [];
    foreach ($files as $file) {
        if ($file['type'] === 'file' && preg_match('/\.(png|jpg|jpeg|webp)$/i', $file['name'])) {
            $validImgs[] = "https://cdn.jsdelivr.net/gh/MANKALOHO/wallpaper-picbed@main/{$file['path']}";
        }
    }
    $randomImg = $validImgs[array_rand($validImgs)] ?? '';

    // 3. 返回HTTP 302跳转（关键：让插件直接拿到图片直链）
    if (!empty($randomImg)) {
        header("Location: {$randomImg}"); // 告诉浏览器跳转到图片直链
        header("HTTP/1.1 302 Temporary Redirect");
        exit; // 终止后续HTML输出，确保跳转生效
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二次元动漫壁纸接口</title>
    <style>
        body { margin: 2rem; font-family: sans-serif; background: #f8f9fa; }
        h1 { color: #333; }
        .api-desc { margin: 1rem 0; padding: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .api-link { color: #0969da; text-decoration: none; font-weight: 500; }
        .api-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>二次元动漫壁纸图床 & 接口</h1>
    <div class="api-desc">
        <p><strong>1. 随机获取一张动漫壁纸（直接返回图片）</strong><br>
        调用地址：<a href="?type=random" class="api-link">https://api.tengyuesj.cn?type=random</a></p>
        
        <p><strong>2. 随机壁纸接口（返回JSON数据）</strong><br>
        调用地址：<a href="?type=random&format=json" class="api-link">https://api.tengyuesj.cn?type=random&format=json</a></p>
        
        <p><strong>3. 获取所有动漫壁纸列表（JSON）</strong><br>
        调用地址：<a href="?type=list&format=json" class="api-link">https://api.tengyuesj.cn?type=list&format=json</a></p>
    </div>

    <script>
        // 保留原JS逻辑（兼容浏览器访问，服务器端跳转失败时 fallback）
        const urlParams = new URLSearchParams(window.location.search);
        const apiType = urlParams.get('type');
        const returnFormat = urlParams.get('format');
        const fetchUrl = 'https://api.github.com/repos/MANKALOHO/wallpaper-picbed/contents/2025';

        fetch(fetchUrl)
            .then(res => res.json())
            .then(files => {
                const animeWallpapers = files
                    .filter(file => file.type === 'file' && /\.(png|jpg|jpeg|webp)$/i.test(file.name))
                    .map(file => ({
                        wallpaperName: file.name,
                        wallpaperUrl: `https://cdn.jsdelivr.net/gh/MANKALOHO/wallpaper-picbed@main/${file.path}`,
                        fileSize: (file.size / 1024).toFixed(2) + 'KB',
                        updateTime: new Date(file.last_modified).toLocaleDateString()
                    }));

                if (apiType === 'random') {
                    const randomWallpaper = animeWallpapers[Math.floor(Math.random() * animeWallpapers.length)];
                    if (returnFormat === 'json') {
                        document.write(JSON.stringify({
                            code: 200,
                            message: '二次元动漫随机壁纸获取成功',
                            data: {
                                壁纸名称: randomWallpaper.wallpaperName,
                                壁纸直链: randomWallpaper.wallpaperUrl,
                                文件大小: randomWallpaper.fileSize,
                                最后更新: randomWallpaper.updateTime
                            }
                        }, null, 2));
                        document.body.style.whiteSpace = 'pre';
                    } else {
                        window.location.href = randomWallpaper.wallpaperUrl;
                    }
                } else if (apiType === 'list' && returnFormat === 'json') {
                    document.write(JSON.stringify({
                        code: 200,
                        message: '二次元动漫壁纸列表获取成功',
                        totalCount: animeWallpapers.length,
                        wallpaperList: animeWallpapers
                    }, null, 2));
                    document.body.style.whiteSpace = 'pre';
                } else {
                    document.querySelector('.api-desc').insertAdjacentHTML('afterend', `
                        <h2>壁纸预览（共 ${animeWallpapers.length} 张）</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
                            ${animeWallpapers.map(wp => `
                                <div style="background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                                    <img src="${wp.wallpaperUrl}" style="width: 100%; height: 300px; object-fit: cover;" alt="${wp.wallpaperName}">
                                    <div style="padding: 0.8rem; font-size: 0.9rem; color: #666;">${wp.wallpaperName}</div>
                                </div>
                            `).join('')}
                        </div>
                    `);
                }
            })
            .catch(err => {
                const errorMsg = err.message.includes('mixed content') 
                    ? '接口请求失败：当前为HTTP访问，建议开启SSL（HTTPS）以兼容CDN资源'
                    : err.message;
                document.write(JSON.stringify({
                    code: 500,
                    message: '接口请求失败',
                    error: errorMsg
                }, null, 2));
            });
    </script>
</body>
</html>
